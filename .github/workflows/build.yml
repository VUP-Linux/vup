name: Build and Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  packages: read

env:
  XBPS_ALLOW_RESTRICTED: yes
  XBPS_ALLOW_CHROOT_BREAKOUT: yes

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_run: ${{ steps.set-matrix.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine Systems to Build
        id: set-matrix
        env:
          BEFORE_SHA: ${{ github.event.before }}
        run: |
          chmod +x vup/scripts/check_changes.py
          python3 vup/scripts/check_changes.py

  build:
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vup-linux/vup-builder:latest
      options: --privileged
    strategy:
      matrix: ${{ fromJson(needs.check-changes.outputs.matrix) }}
      fail-fast: false
    concurrency:
      group: vup-build-${{ matrix.category }}
      cancel-in-progress: true
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
        with:
          path: vup
          fetch-depth: 0

      - name: Checkout void-packages
        uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          path: void-packages

      - name: Cache xbps-src bootstrap & ccache
        id: cache-xbps
        uses: actions/cache@v3
        with:
          path: |
            void-packages/masterdir-*
            void-packages/hostdir/repocache
            void-packages/hostdir/ccache
          key: xbps-cache-${{ runner.os }}-${{ hashFiles('void-packages/srcpkgs/base-chroot/template') }}
          restore-keys: |
            xbps-cache-${{ runner.os }}-

      - name: Setup xbps-src
        run: |
          cd void-packages
          cp ../vup/vup/xbps-src .
          chmod +x xbps-src
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf
          echo "XBPS_CCACHE=yes" >> etc/conf
          mkdir -p hostdir/ccache

      - name: Binary Bootstrap
        if: steps.cache-xbps.outputs.cache-hit != 'true'
        run: |
          cd void-packages
          ./xbps-src binary-bootstrap

      - name: Build Packages (Buffered)
        env:
          CATEGORY: ${{ matrix.category }}
        run: |
          cd void-packages
          python3 ../vup/vup/scripts/build_runner.py

      - name: Prepare Artifacts
        run: |
          mkdir -p dist-out
          if [ -d "void-packages/dist" ]; then
             cp -r void-packages/dist/* dist-out/
          fi
          mkdir -p logs-out
          cp void-packages/report-${{ matrix.category }}.json logs-out/
          cp void-packages/build-logs/*.log logs-out/

      - name: Upload Binpkgs
        uses: actions/upload-artifact@v4
        with:
          name: binpkgs-${{ matrix.category }}
          path: dist-out
          if-no-files-found: ignore

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.category }}
          path: logs-out
          if-no-files-found: ignore

  release:
    needs: [check-changes, build]
    if: needs.check-changes.outputs.should_run == 'true' && always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vup-linux/vup-builder:latest
      options: --privileged
    strategy:
      matrix: ${{ fromJson(needs.check-changes.outputs.matrix) }}
      fail-fast: false
    
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
        with:
          path: vup

      - name: Prepare Workspace
        run: |
          mkdir -p work/dist

      - name: Download Old Release and Sync
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          CATEGORY: ${{ matrix.category }}
        run: |
          cd work
          # Helper to safely move dist content
          python3 ${{ github.workspace }}/vup/vup/scripts/manage_release.py download || true
          # manage_release.py download might fail if tag doesn't exist, which is fine for first run

      - name: Download New Binpkgs
        uses: actions/download-artifact@v4
        with:
          name: binpkgs-${{ matrix.category }}
          path: work/dist

      - name: Prune and Sign
        env:
          XBPS_PRIVATE_KEY: ${{ secrets.XBPS_PRIVATE_KEY }}
          CATEGORY: ${{ matrix.category }}
        run: |
          cd work
          # Remove repodata to regenerate
          rm -f dist/repodata
          
          # Prune old packages
          python3 ${{ github.workspace }}/vup/vup/scripts/manage_release.py prune
          
          # Sign and Index
          python3 ${{ github.workspace }}/vup/vup/scripts/manage_release.py update_repo

      - name: Clean Remote Assets
        env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
           GITHUB_REPOSITORY: ${{ github.repository }}
           CATEGORY: ${{ matrix.category }}
        run: |
           cd work
           python3 ${{ github.workspace }}/vup/vup/scripts/manage_release.py clean_remote

      - name: Upload Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ matrix.category }}-current
          files: work/dist/*
          fail_on_unmatched_files: true

  report-status:
    needs: [build, release]
    if: always() && needs.build.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Reports
        uses: actions/download-artifact@v4
        with:
          pattern: build-logs-*
          path: reports
          merge-multiple: true
      
      - name: Generate Summary
        id: summary
        run: |
           echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
           chmod +x vup/scripts/generate_summary.py
           
           for report_file in reports/*.json; do
              [ -e "$report_file" ] || continue
              cat "$report_file" | python3 vup/scripts/generate_summary.py >> $GITHUB_STEP_SUMMARY
           done

  deploy-index:
    needs: [check-changes, release]
    if: needs.check-changes.outputs.should_run == 'true' && always() && needs.release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate Global Index
        run: |
          python3 vup/scripts/generate_index.py
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
          keep_files: false
