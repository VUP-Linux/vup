name: Vuru Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
permissions:
  contents: write


jobs:
  build-vuru:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-glibc:latest
      options: --privileged
    env:
      XBPS_ALLOW_RESTRICTED: yes
      XBPS_ALLOW_CHROOT_BREAKOUT: yes
    
    steps:
      - name: Install Dependencies
        run: |
          xbps-install -Sy git curl bash python3 github-cli util-linux shadow findutils tar gzip
          xbps-install -y gcc pkg-config # Essential for cargo builds if not in base

      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          path: vup
          fetch-depth: 0

      - name: Checkout void-packages
        uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          path: void-packages

      - name: Cache xbps-src bootstrap
        id: cache-bootstrap
        uses: actions/cache@v3
        with:
          path: |
            void-packages/masterdir-*
            void-packages/hostdir/repocache
          key: xbps-bootstrap-${{ runner.os }}-${{ hashFiles('void-packages/srcpkgs/base-chroot/template') }}
          restore-keys: |
            xbps-bootstrap-${{ runner.os }}-

      - name: Setup xbps-src
        run: |
          cd void-packages
          # Override xbps-src with our custom version
          cp ../vup/vup/xbps-src .
          chmod +x xbps-src
          
          # Authorize restricted packages
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf

      - name: Binary Bootstrap
        if: steps.cache-bootstrap.outputs.cache-hit != 'true'
        run: |
          cd void-packages
          # Override xbps-src with our custom version
          cp ../vup/vup/xbps-src .
          chmod +x xbps-src
          
          ./xbps-src binary-bootstrap

      - name: Build Vuru
        run: |
          # Extract version from tag (e.g. v0.2.1 -> 0.2.1)
          VERSION=${GITHUB_REF_NAME#v}
          echo "Building Vuru version $VERSION"

          # Define absolute paths
          VUP_DIR="$GITHUB_WORKSPACE/vup"
          VOID_DIR="$GITHUB_WORKSPACE/void-packages"
          DIST_TMP="$GITHUB_WORKSPACE/dist-tmp"

          cd "$VOID_DIR"
          # Copy template
          mkdir -p srcpkgs/vuru
          cp "$VUP_DIR/vup/srcpkgs/core/vuru/template" srcpkgs/vuru/
          
          # HACK: Create local distfile so xbps-src finds it
          mkdir -p "hostdir/sources/vuru-$VERSION"
          
          # Create source tarball
          mkdir -p "$DIST_TMP/vup-v$VERSION"
          cp -r "$VUP_DIR/vuru" "$DIST_TMP/vup-v$VERSION/"
          
          cd "$DIST_TMP"
          tar -czf "source.tar.gz" "vup-v$VERSION"
          
          # Move to void-packages distfiles
          mv "source.tar.gz" "$VOID_DIR/hostdir/sources/vuru-$VERSION/v$VERSION.tar.gz"
          
          cd "$VOID_DIR"
          # Update checksum
          SHA=$(sha256sum "hostdir/sources/vuru-$VERSION/v$VERSION.tar.gz" | cut -d' ' -f1)
          sed -i "s/checksum=\".*\"/checksum=\"$SHA\"/" srcpkgs/vuru/template
          
          # Build
          ./xbps-src pkg vuru

      - name: Create Repo Index
        run: |
          cd void-packages/hostdir/binpkgs
          xbps-rindex -a *.xbps
          
      - name: Release Binary Package
        uses: softprops/action-gh-release@v1
        with:
          tag_name: vuru-current
          files: |
            void-packages/hostdir/binpkgs/vuru-*.xbps
            void-packages/hostdir/binpkgs/repodata

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
