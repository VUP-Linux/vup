name: PR Check

on:
  pull_request:
    paths:
      - 'vup/srcpkgs/**/*'

env:
  XBPS_ALLOW_RESTRICTED: yes
  XBPS_ALLOW_CHROOT_BREAKOUT: yes

permissions:
  contents: read
  packages: read

jobs:
  verify-build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/vup-linux/vup-builder:latest
      options: --privileged
    strategy:
      matrix:
        category: [core, utilities, editors, chat]
      fail-fast: false
    
    concurrency:
      group: pr-vup-${{ matrix.category }}-${{ github.head_ref }}
      cancel-in-progress: true
    
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
        with:
          path: vup
          fetch-depth: 0

      - name: Check for modified packages
        id: check_changes
        run: |
          git config --global --add safe.directory "$PWD/vup"
          cd vup
          CHANGED=$(git diff --name-only origin/main HEAD | grep "srcpkgs/${{ matrix.category }}" || true)
          
          if [ -z "$CHANGED" ]; then
             echo "No changes in ${{ matrix.category }}, skipping."
             echo "skip=true" >> $GITHUB_OUTPUT
          else
             echo "Changes detected in ${{ matrix.category }}."
             echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout void-packages (Build System)
        if: steps.check_changes.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          path: void-packages

      - name: Cache xbps-src bootstrap
        if: steps.check_changes.outputs.skip != 'true'
        id: cache-bootstrap
        uses: actions/cache@v3
        with:
          path: |
            void-packages/masterdir-*
            void-packages/hostdir/repocache
          key: xbps-bootstrap-${{ runner.os }}-${{ hashFiles('void-packages/srcpkgs/base-chroot/template') }}
          restore-keys: |
            xbps-bootstrap-${{ runner.os }}-

      - name: Setup xbps-src
        if: steps.check_changes.outputs.skip != 'true'
        run: |
          cd void-packages
          # Override xbps-src with our custom version
          cp ../vup/vup/xbps-src .
          chmod +x xbps-src
          
          # Authorize restricted packages
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf

      - name: Binary Bootstrap
        if: steps.check_changes.outputs.skip != 'true' && steps.cache-bootstrap.outputs.cache-hit != 'true'
        run: |
          cd void-packages
          ./xbps-src binary-bootstrap

      - name: Build Modified Packages
        if: steps.check_changes.outputs.skip != 'true'
        run: |
          cd void-packages
          cat_path="../vup/vup/srcpkgs/${{ matrix.category }}"
          
          # Get list of modified template dirs
          cd ../vup
          MODIFIED_PKGS=$(git diff --name-only origin/main HEAD | grep "srcpkgs/${{ matrix.category }}" | cut -d/ -f4 | sort -u)
          cd ../void-packages
          
          mkdir -p ../reports
          REPORT_FILE="../reports/report-${{ matrix.category }}.json"
          
          results="[]"
          
          for pkgname in $MODIFIED_PKGS; do
             pkgpath="$cat_path/$pkgname"
             if [ -d "$pkgpath" ]; then
                 echo "Using template from $pkgpath"
                 
                 # Prepare reporting entry
                 status="pending"
                 log=""
                 
                 rm -rf "srcpkgs/$pkgname"
                 cp -r "$pkgpath" "srcpkgs/"
                 
                 echo "Building $pkgname..."
                 if ./xbps-src -Q pkg "$pkgname" > build.log 2>&1; then
                     echo "Build SUCCESS: $pkgname"
                     status="success"
                 else
                     echo "Build FAILED: $pkgname"
                     status="failure"
                     # Capture last 50 lines of log
                     log=$(tail -n 50 build.log)
                     cat build.log
                 fi
                 
                 # Append to JSON results (using python for safe json handling)
                 encoded_log=$(python3 -c "import json, sys; print(json.dumps(sys.argv[1]))" "$log")
                 results=$(python3 -c "import json, sys; res=json.loads(sys.argv[1]); res.append({'package': '$pkgname', 'status': '$status', 'log': $encoded_log}); print(json.dumps(res))" "$results")
                 
                 rm -rf "srcpkgs/$pkgname"
             fi
          done
          
          # Write report
          echo "$results" > "$REPORT_FILE"

      - name: Upload Build Artifacts
        if: steps.check_changes.outputs.skip != 'true' && always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-report-${{ matrix.category }}
          path: reports/*.json
