name: PR Check

on:
  pull_request:
    paths:
      - 'vup/srcpkgs/**/*'

env:
  XBPS_ALLOW_RESTRICTED: yes
  XBPS_ALLOW_CHROOT_BREAKOUT: yes

permissions:
  contents: read
  packages: read

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      should_run: ${{ steps.set-matrix.outputs.should_run }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Systems to Build
        id: set-matrix
        run: |
          git config --global --add safe.directory "$PWD"
          # Fetch main to ensure we have the reference for diff
          git fetch origin main

          # Actual Script
          python3 -c '
          import os, subprocess, json, sys

          def main():
              # We need to list all categories first
              # Assuming checkout at vup/
              base_path = "vup/vup/srcpkgs"
              if not os.path.exists(base_path):
                  # Fallback to root (if paths differ)
                  base_path = "vup/srcpkgs"
              
              if not os.path.exists(base_path):
                   print(f"Could not find srcpkgs at {base_path}")
                   # Return empty
                   with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
                       gh.write("should_run=false\n")
                       gh.write("matrix={\"category\":[]}\n")
                   return

              all_cats = [d for d in os.listdir(base_path) if os.path.isdir(os.path.join(base_path, d))]
              
              cmd = ["git", "diff", "--name-only", "origin/main", "HEAD"]
              try:
                  changes = subprocess.check_output(cmd).decode().splitlines()
              except:
                  changes = []
              
              target_cats = set()
              for f in changes:
                  # Path: vup/srcpkgs/<cat>/<pkg>...
                  # Since we checked out to "vup", git diff runs inside that repo?
                  # If file path matches srcpkgs/<cat>
                  parts = f.split("/")
                  # Expected: vup/srcpkgs/category/pkg (if repo has vup/srcpkgs)
                  # In this repo, struct is vup/srcpkgs.
                  
                  # Robust detection
                  if "srcpkgs/" in f:
                      # find index
                      idx = parts.index("srcpkgs")
                      if idx + 1 < len(parts):
                          cat = parts[idx+1]
                          if cat in all_cats:
                              target_cats.add(cat)
              
              target_list = sorted(list(target_cats))
              
              if not target_list:
                  print("No relevant changes.")
                  with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
                       gh.write("should_run=false\n")
                       gh.write("matrix={\"category\":[]}\n")
              else:
                  print(f"Building categories: {target_list}")
                  matrix_json = json.dumps({"category": target_list})
                  with open(os.environ["GITHUB_OUTPUT"], "a") as gh:
                       gh.write("should_run=true\n")
                       gh.write(f"matrix={matrix_json}\n")
          main()
          '

  verify-build:
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    container:
      image: ghcr.io/vup-linux/vup-builder:latest
      options: --privileged
    strategy:
      matrix: ${{ fromJson(needs.check-changes.outputs.matrix) }}
      fail-fast: false
    
    concurrency:
      group: pr-vup-${{ matrix.category }}-${{ github.head_ref }}
      cancel-in-progress: true
    
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
        with:
          path: vup
          fetch-depth: 0

      - name: Checkout void-packages (Build System)
        uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          path: void-packages

      - name: Cache xbps-src bootstrap

        id: cache-bootstrap
        uses: actions/cache@v3
        with:
          path: |
            void-packages/masterdir-*
            void-packages/hostdir/repocache
          key: xbps-bootstrap-${{ runner.os }}-${{ hashFiles('void-packages/srcpkgs/base-chroot/template') }}
          restore-keys: |
            xbps-bootstrap-${{ runner.os }}-

      - name: Setup xbps-src

        run: |
          cd void-packages
          # Override xbps-src with our custom version
          cp ../vup/vup/xbps-src .
          chmod +x xbps-src
          
          # Authorize restricted packages
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf

      - name: Binary Bootstrap
        if: steps.cache-bootstrap.outputs.cache-hit != 'true'
        run: |
          cd void-packages
          ./xbps-src binary-bootstrap

      - name: Build Modified Packages

        run: |
          cd void-packages
          cat_path="../vup/vup/srcpkgs/${{ matrix.category }}"
          
          # Get list of modified template dirs
          cd ../vup
          MODIFIED_PKGS=$(git diff --name-only origin/main HEAD | grep "srcpkgs/${{ matrix.category }}" | cut -d/ -f4 | sort -u)
          cd ../void-packages
          
          mkdir -p ../reports
          REPORT_FILE="../reports/report-${{ matrix.category }}.json"
          
          results="[]"
          
          for pkgname in $MODIFIED_PKGS; do
             pkgpath="$cat_path/$pkgname"
             if [ -d "$pkgpath" ]; then
                 echo "Using template from $pkgpath"
                 
                 # Prepare reporting entry
                 status="pending"
                 log=""
                 
                 rm -rf "srcpkgs/$pkgname"
                 cp -r "$pkgpath" "srcpkgs/"
                 
                 echo "Building $pkgname..."
                 if ./xbps-src -Q pkg "$pkgname" > build.log 2>&1; then
                     echo "Build SUCCESS: $pkgname"
                     status="success"
                 else
                     echo "Build FAILED: $pkgname"
                     status="failure"
                     # Capture last 50 lines of log
                     log=$(tail -n 50 build.log)
                     cat build.log
                 fi
                 
                 # Append to JSON results (using python for safe json handling)
                 encoded_log=$(python3 -c "import json, sys; print(json.dumps(sys.argv[1]))" "$log")
                 results=$(python3 -c "import json, sys; res=json.loads(sys.argv[1]); res.append({'package': '$pkgname', 'status': '$status', 'log': $encoded_log}); print(json.dumps(res))" "$results")
                 
                 rm -rf "srcpkgs/$pkgname"
             fi
          done
          
          # Write report
          echo "$results" > "$REPORT_FILE"

      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-report-${{ matrix.category }}
          path: reports/*.json
