name: PR Check

on:
  pull_request:
    paths:
      - 'vup/srcpkgs/**/*'

env:
  XBPS_ALLOW_RESTRICTED: yes
  XBPS_ALLOW_CHROOT_BREAKOUT: yes

jobs:
  labeler:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: vup/.github/labeler.yml

  verify-build:
    runs-on: ubuntu-latest
    needs: labeler
    container:
      image: ghcr.io/VUP-Linux/vup-builder:latest
      options: --privileged
    strategy:
      matrix:
        category: [core, utilities, editors, chat]
      fail-fast: false
    
    # Conditional execution: Only run if the PR has the corresponding label OR if we detect changes in that dir.
    # Since matrix jobs are static, we check inside the step or use an `if` at job level.
    # A cleaner logic for large scale is dynamic matrix, but here we can check if any files changed in that category using git.
    
    # Prevent wasted builds on PR updates
    concurrency:
      group: pr-vup-${{ matrix.category }}-${{ github.head_ref }}
      cancel-in-progress: true
    
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
        with:
          path: vup
          fetch-depth: 0 # Need history to diff

      - name: Check for modified packages in ${{ matrix.category }}
        id: check_changes
        run: |
          # Check if any file in vup/srcpkgs/${{ matrix.category }} matches the diff
          # We compare against origin/main. In a PR, headers usually set GITHUB_BASE_REF
          
          # Mark safe dir
          git config --global --add safe.directory "$PWD/vup"
          
          cd vup
          CHANGED=$(git diff --name-only origin/main HEAD | grep "srcpkgs/${{ matrix.category }}" || true)
          
          if [ -z "$CHANGED" ]; then
             echo "No changes in ${{ matrix.category }}, skipping."
             echo "skip=true" >> $GITHUB_OUTPUT
          else
             echo "Changes detected in ${{ matrix.category }}."
             echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout void-packages (Build System)
        if: steps.check_changes.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          repository: void-linux/void-packages
          path: void-packages

      - name: Cache xbps-src bootstrap
        if: steps.check_changes.outputs.skip != 'true'
        id: cache-bootstrap
        uses: actions/cache@v3
        with:
          path: |
            void-packages/masterdir-*
            void-packages/hostdir/repocache
          key: xbps-bootstrap-${{ runner.os }}-${{ hashFiles('void-packages/srcpkgs/base-chroot/template') }}
          restore-keys: |
            xbps-bootstrap-${{ runner.os }}-

      - name: Setup xbps-src
        if: steps.check_changes.outputs.skip != 'true'
        run: |
          cd void-packages
          # Override xbps-src with our custom version
          cp ../vup/vup/xbps-src .
          chmod +x xbps-src
          
          # Authorize restricted packages
          echo "XBPS_ALLOW_RESTRICTED=yes" >> etc/conf

      - name: Binary Bootstrap
        if: steps.check_changes.outputs.skip != 'true' && steps.cache-bootstrap.outputs.cache-hit != 'true'
        run: |
          cd void-packages
          ./xbps-src binary-bootstrap

      - name: Build Modified Packages
        if: steps.check_changes.outputs.skip != 'true'
        run: |
          cd void-packages
          CATEGORY_PATH="../vup/vup/srcpkgs/${{ matrix.category }}"
          
          # Re-detect changed packages to iterate specifically over them
          # Or just build everything in the category that is present? 
          # Better: Extract pkgnames from git diff to only build modified ones.
          
          cd ../vup
          # Get list of modified template dirs
          MODIFIED_PKGS=$(git diff --name-only origin/main HEAD | grep "srcpkgs/${{ matrix.category }}" | cut -d/ -f4 | sort -u)
          cd ../void-packages

          for pkgname in $MODIFIED_PKGS; do
             pkgpath="$CATEGORY_PATH/$pkgname"
             if [ -d "$pkgpath" ]; then
                 echo "Verifying build for $pkgname..."
                 
                 # Copy template for isolation
                 rm -rf "srcpkgs/$pkgname"
                 cp -r "$pkgpath" "srcpkgs/"
                 
                 # Build
                 ./xbps-src -Q pkg "$pkgname"
                 
                 # Cleanup
                 rm -rf "srcpkgs/$pkgname"
             fi
          done
