# Template file for 'antigravity' 
pkgname=antigravity
version=1.0.0
revision=1
archs="x86_64 aarch64"
create_wrksrc=yes
hostmakedepends="tar"
depends="
 alsa-lib
 at-spi2-core
 cairo
 dbus
 expat
 libgcc
 glib
 glibc
 gtk+3
 libX11
 libXcomposite
 libXdamage
 libXext
 libXfixes
 libxkbcommon
 libxkbfile
 libXrandr
 libxcb
 mesa
 nspr
 nss
 pango
 cups
"
short_desc="An agentic development platform from Google"
maintainer="AmarBego <begovicamar@proton.me>"
license="custom:Google-Antigravity"
homepage="https://antigravity.google/"
restricted=yes
nopie=yes
nostrip=yes
noshlibprovides=yes

case "${XBPS_TARGET_MACHINE}" in
	x86_64)
		_debfile="${pkgname}_${version}-1763466940_amd64_f36c43ea9197552851df8c4000d2642d.deb"
		checksum="355cb727288e9b11d61a0f4fca07c96c78be367d38e0ed0942517e283d1558e0"
		;;
	aarch64)
		_debfile="${pkgname}_${version}-1763466926_arm64_0e1e4e69b1082e1c227c060e96877cc5.deb"
		checksum="39a791a97906f8e99d027631ba753071b111c2991fd8be91052392262126687f"
		;;
esac

distfiles="https://us-central1-apt.pkg.dev/projects/${pkgname}-auto-updater-dev/pool/${pkgname}-debian/${_debfile}"

do_install() {
	# deb contents are extracted to $wrksrc by do_extract
	vcopy usr .

	# Fix zsh completions
	if [ -d ${DESTDIR}/usr/share/zsh/vendor-completions ]; then
		vmkdir usr/share/zsh/site-functions
		mv ${DESTDIR}/usr/share/zsh/vendor-completions/* ${DESTDIR}/usr/share/zsh/site-functions/
		rm -rf ${DESTDIR}/usr/share/zsh/vendor-completions
	fi

	# Move /usr/share/antigravity to /opt/Antigravity
	vmkdir opt
	mv ${DESTDIR}/usr/share/antigravity ${DESTDIR}/opt/Antigravity

	for f in ${DESTDIR}/usr/share/applications/*.desktop; do
		vsed -i "$f" -e 's|/usr/share/antigravity|/opt/Antigravity|g'
		vsed -i "$f" -e 's|Exec=/opt/Antigravity/antigravity|Exec=/usr/bin/antigravity|g'
	done

	# Helper script with flags config support and workarounds for known issues
	cat > antigravity.sh <<EOF
#!/bin/bash
XDG_CONFIG_HOME=\${XDG_CONFIG_HOME:-~/.config}

# Disable core dumps to prevent disk space issues (upstream bug causes crash loops)
ulimit -c 0

# Allow users to override command-line options
if [[ -f \$XDG_CONFIG_HOME/antigravity-flags.conf ]]; then
   ANTIGRAVITY_USER_FLAGS="\$(sed 's/#.*//' \$XDG_CONFIG_HOME/antigravity-flags.conf | tr '\n' ' ')"
fi

# Wayland native support (use proper flag format)
if [[ \$XDG_SESSION_TYPE == "wayland" ]]; then
   WAYLAND_FLAGS="--ozone-platform-hint=auto"
fi

# Flags to help with service worker and sandbox issues
STABILITY_FLAGS="--disable-gpu-sandbox --no-sandbox"

# Cleanup function for orphaned processes
cleanup() {
    pkill -P \$\$ 2>/dev/null
}
trap cleanup EXIT

# Launch
/opt/Antigravity/bin/antigravity "\$@" \$WAYLAND_FLAGS \$STABILITY_FLAGS \$ANTIGRAVITY_USER_FLAGS
EXIT_CODE=\$?

# Extra cleanup for any lingering child processes
sleep 1
pkill -9 -f "/opt/Antigravity/bin/antigravity" 2>/dev/null || true

exit \$EXIT_CODE
EOF
	vbin antigravity.sh antigravity

	# License
	vlicense ${DESTDIR}/opt/Antigravity/resources/app/LICENSE.txt
	vlicense ${DESTDIR}/opt/Antigravity/LICENSES.chromium.html
}
