name: Build and Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  XBPS_ALLOW_RESTRICTED: yes

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category: [utilities, editors, chat]
        # In a real dynamic setup, we'd determine modified categories dynamically.
        # For this prototype, we just define them statically.

    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4

      - name: Prepare Void Environment
        # In reality, this would use a docker container or install xbps-src
        # For this mock, we assume valid environment or mock it
        run: echo "Setting up xbps-src environment..."

      - name: Build Packages in ${{ matrix.category }}
        run: |
          echo "Building packages for category: ${{ matrix.category }}"
          # Mock build loop
          # for pkg in vup/srcpkgs/${{ matrix.category }}/*; do
          #   ./xbps-src pkg $(basename $pkg)
          # done
      
      - name: Generate Repodata
        run: |
          echo "Generating repodata for ${{ matrix.category }}..."
          # xbps-rindex -a vup/binpkgs/${{ matrix.category }}/*.xbps
          
          # Create dummy artifact for demo
          mkdir -p dist/${{ matrix.category }}
          touch dist/${{ matrix.category }}/repodata
          touch dist/${{ matrix.category }}/mock-package.xbps

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ matrix.category }}-current
          files: dist/${{ matrix.category }}/*
          overwrite: true
          project: ${{ matrix.category }} # Custom logic might be needed here to handle multiple releases in one repo contextually

  update-index:
    needs: build-and-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout VUP
        uses: actions/checkout@v4
      
      - name: Generate Global Index
        run: |
          python3 vup/scripts/gen_index.py
          
      - name: Deploy Index to Pages/Release
        # This would deploy index.json to a public URL
        run: echo "Deploying index.json..."
